<!-- This test validates that MonoRuntimeMixedModeExcludedAssembly works independently 
     without requiring WasmShellAOTProfileExcludedMethods -->
<Project Sdk="Microsoft.NET.Sdk.WebAssembly">

	<PropertyGroup>
		<TargetFramework>net10.0</TargetFramework>
		<OutputType>Exe</OutputType>
		<IsPackable>false</IsPackable>
		
		<!-- Enable Mixed Mode AOT -->
		<WasmShellMonoRuntimeExecutionMode>InterpreterAndAOT</WasmShellMonoRuntimeExecutionMode>
		<RunAOTCompilation>true</RunAOTCompilation>
		
		<!-- Enable AOT profile debug list generation to verify filtering works -->
		<WasmShellGenerateAOTProfileDebugList>true</WasmShellGenerateAOTProfileDebugList>
		
		<!-- Important: We deliberately DO NOT set WasmShellAOTProfileExcludedMethods 
		     to test that MonoRuntimeMixedModeExcludedAssembly works independently -->
	</PropertyGroup>

	<ItemGroup>
		<!-- Add a dependency that we'll exclude from AOT -->
		<PackageReference Include="Newtonsoft.Json" Version="13.0.2" />
	</ItemGroup>

	<ItemGroup>
		<!-- Test that this works without WasmShellAOTProfileExcludedMethods being set -->
		<MonoRuntimeMixedModeExcludedAssembly Include="Newtonsoft.Json" />
		<MonoRuntimeMixedModeExcludedAssembly Include="System.Xml" />
	</ItemGroup>

	<ItemGroup>
		<!-- Use a sample AOT profile for testing -->
		<WasmShellEnableAotProfile Include="aot.profile" />
	</ItemGroup>

	<Import Project="..\Uno.Wasm.Bootstrap\build\Uno.Wasm.Bootstrap.props" />
	<Import Project="..\Uno.Wasm.Bootstrap\build\Uno.Wasm.Bootstrap.targets" />

	<ItemGroup>
		<ProjectReference Include="..\Uno.Wasm.Bootstrap\Uno.Wasm.Bootstrap.csproj">
			<ReferenceOutputAssembly>false</ReferenceOutputAssembly>
			<SkipGetTargetFrameworkProperties>true</SkipGetTargetFrameworkProperties>
			<UndefineProperties>TargetFramework</UndefineProperties>
		</ProjectReference>
	</ItemGroup>

	<!-- Post-build validation target -->
	<Target Name="ValidateMixedModeProfileFiltering" AfterTargets="Build">
		<PropertyGroup>
			<_originalProfilePath>$(IntermediateOutputPath)AOTProfileDump.Original.txt</_originalProfilePath>
			<_filteredProfilePath>$(IntermediateOutputPath)AOTProfileDump.Filtered.txt</_filteredProfilePath>
		</PropertyGroup>

		<!-- Verify that both debug dump files were generated -->
		<Error Condition="!Exists('$(_originalProfilePath)')" 
		       Text="AOTProfileDump.Original.txt was not generated. MonoRuntimeMixedModeExcludedAssembly may not be working correctly." />
		
		<Error Condition="!Exists('$(_filteredProfilePath)')" 
		       Text="AOTProfileDump.Filtered.txt was not generated. Profile filtering for MonoRuntimeMixedModeExcludedAssembly is not being applied." />

		<Message Importance="high" Text="âœ“ Profile filtering validated: Both Original and Filtered AOT profile dumps were generated successfully." />
		<Message Importance="high" Text="  - Original profile: $(_originalProfilePath)" />
		<Message Importance="high" Text="  - Filtered profile: $(_filteredProfilePath)" />
	</Target>

</Project>
