<Project>
	<PropertyGroup>
		<_UnoBootstrapTaskBinary>$(MSBuildThisFileDirectory)../tools/Uno.Wasm.Bootstrap.v0.dll</_UnoBootstrapTaskBinary>

		<_WasmShellTasksPathIsDevMode>false</_WasmShellTasksPathIsDevMode>
		<_WasmShellTasksPathIsDevMode Condition="!Exists('$(_UnoBootstrapTaskBinary)')">true</_WasmShellTasksPathIsDevMode>
		<WasmShellTasksPath Condition="$(_WasmShellTasksPathIsDevMode)">$(MSBuildThisFileDirectory)../bin/$(Configuration)/netstandard2.0</WasmShellTasksPath>
		<WasmShellTasksPath Condition="!$(_WasmShellTasksPathIsDevMode)">../tools</WasmShellTasksPath>

		<WasmShellIndexHtmlPath Condition="!Exists('$(_UnoBootstrapTaskBinary)')">$(MSBuildThisFileDirectory)../Templates/index.html</WasmShellIndexHtmlPath>
		<WasmShellIndexHtmlPath Condition="Exists('$(_UnoBootstrapTaskBinary)') and '$(WasmShellIndexHtmlPath)'==''">$(MSBuildThisFileDirectory)../tools/templates/index.html</WasmShellIndexHtmlPath>

		<WasmShellContentExtensionsToExclude Condition="'$(WasmShellContentExtensionsToExclude)' == ''">.a;.bc;.o</WasmShellContentExtensionsToExclude>
	</PropertyGroup>

	<!-- AOT Profiling support -->
	<PropertyGroup Condition=" '$(WasmShellGenerateAOTProfile)' == 'true' ">
		<!-- Enable AOT profiling using a single property -->
		<WasmProfilers>$(WasmProfilers);aot;</WasmProfilers>

		<!-- Make the build faster by disabling compression -->
		<DisableBuildCompression>true</DisableBuildCompression>

		<!-- Disable AOT Compilation, log profiler can't trace calls in that mode -->
		<RunAOTCompilation>false</RunAOTCompilation>

		<!-- Ensure that emcc is running so the log profiler is included -->
		<WasmBuildNative>true</WasmBuildNative>
	</PropertyGroup>

	<Target Name="_UnoInjectAOTSupport"
			BeforeTargets="ResolveRuntimePackAssets"
			Condition=" '$(WasmShellGenerateAOTProfile)' == 'true' ">
		<ItemGroup>
			<Reference Include="$(MSBuildThisFileDirectory)../tools/support/Uno.Wasm.AotProfiler.dll" CopyToOutputDirectory="Always" PostProcessAssembly="true" />
			<TrimmerRootAssembly Include="Uno.Wasm.AotProfiler" />
		</ItemGroup>
	</Target>

	<Target Name="_UnoAdjustCompatibility"
			BeforeTargets="ResolveStaticWebAssetsConfiguration">

		<ItemGroup>
			<!-- PInvoke compat -->
			<_WasmPInvokeModules Include="__Native" />
			<_WasmPInvokeModules Include="__Internal" />
			<_WasmPInvokeModules Include="@(WasmShellAdditionalPInvokeLibrary)" />

			<!-- emcc methods compatibility -->
			<EmccExportedRuntimeMethod Include="@(WasmShellEmccExportedRuntimeMethod)" />

			<!-- Native files compat -->
			<NativeFileReference Include="@(WasmShellNativeCompile)" />

			<_NativeAssetsFiltered Include="@(Assets)" Condition=" '%(Extension)'=='.a' OR '%(Extension)'=='.o' OR '%(Extension)'=='.bc' " />
		</ItemGroup>

		<PropertyGroup>
			<EmccFlags>$(EmccFlags);@(WasmShellExtraEmccFlags)</EmccFlags>

			<WasmEnableThreads Condition=" '$(WasmShellEnableThreads)' == 'true' ">true</WasmEnableThreads>
			
			<WasmBuildNative Condition=" 
				@(WasmShellAdditionalPInvokeLibrary->Count()) > 0 
				OR @(NativeFileReference->Count()) > 0 
				OR @(_NativeAssetsFiltered->Count()) > 0
				OR @(EmccExportedRuntimeMethod->Count()) > 0
				">true</WasmBuildNative>

			<WasmCachePath>$([System.IO.Path]::GetFullPath('$(IntermediateOutputPath)emsdk-cache'))</WasmCachePath>
		</PropertyGroup>

		<ItemGroup>
			<_NativeAssetsFiltered Remove="@(_NativeAssetsFiltered)" />
		</ItemGroup>
	</Target>

	<UsingTask Condition="!$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.ShellTask_v0" />
	<UsingTask Condition="!$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.ValidateStaticAssets_v0" />
	<UsingTask Condition="!$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.StaticWebAssetsResolverTask_v0" />
	<UsingTask Condition="!$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.RemoveDirTask_v0" />

	<UsingTask Condition="$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.ShellTask_v0" TaskFactory="TaskHostFactory" />
	<UsingTask Condition="$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.ValidateStaticAssets_v0" TaskFactory="TaskHostFactory" />
	<UsingTask Condition="$(_WasmShellTasksPathIsDevMode)" AssemblyFile="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.StaticWebAssetsResolverTask_v0" TaskFactory="TaskHostFactory" />
	<UsingTask Condition="$(_WasmShellTasksPathIsDevMode)" AssemblyFile	="$(WasmShellTasksPath)/Uno.Wasm.Bootstrap.v0.dll" TaskName="Uno.Wasm.Bootstrap.RemoveDirTask_v0" TaskFactory="TaskHostFactory" />

	<Target Name="ValidateAssets" BeforeTargets="_GenerateBuildWasmBootJson">
		<ValidateStaticAssets_v0
			CandidateAssets="@(WasmStaticWebAsset)"
			ExistingEndpoints="@(StaticWebAssetEndpoint)"
			ContentTypeMappings="@(StaticWebAssetContentTypeMapping)" />
	</Target>

	<Target Name="GenerateUnoAssets"
		BeforeTargets="ResolveStaticWebAssetsConfiguration;_UnoWasmNativeForBuild">

		<ItemGroup>
			<!-- Filter ReferenceCopyLocalPaths as it may contain pdbs as well -->
			<_UnoWasmBootstrapAssembliesForReferenceCopyLocalPaths
			  Include="@(ReferenceCopyLocalPaths)"
			  Condition="'%(Extension)' == '.dll'" />
		</ItemGroup>

		<ShellTask_v0
			AssemblyName="$(AssemblyName)"
			Assembly="$(IntermediateOutputPath)$(TargetFileName)"
			Assets="@(Content)"
			ContentExtensionsToExclude="$(WasmShellContentExtensionsToExclude)"
			CSPConfiguration="$(WasmShellCSPConfiguration)"
			CurrentProjectPath="$(MSBuildProjectDirectory)"
			EmbeddedResources="@(EmbeddedResource)"
			EmscriptenVersion="$(EmscriptenVersion)"
			EnableThreads="@(WasmEnableThreads)"
			IndexHtmlPath="$(WasmShellIndexHtmlPath)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			MonoEnvironment="@(WasmShellMonoEnvironment)"
			PWAManifestFile="$(WasmPWAManifestFile)"
			ReferencePath="@(_UnoWasmBootstrapAssembliesForReferenceCopyLocalPaths)"
			GenerateAOTProfile="$(WasmShellGenerateAOTProfile)"
			WebAppBasePath="$(WasmShellWebAppBasePath)"
			>
			<Output TaskParameter="StaticWebContent" ItemName="Content" />
			<Output TaskParameter="NativeFileReference" ItemName="NativeFileReference" />
		</ShellTask_v0>
	</Target>

</Project>
