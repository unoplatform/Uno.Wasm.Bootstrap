<Project>

	<!-- Workaround for https://github.com/unoplatform/Uno.Wasm.Bootstrap/issues/973 -->
	<Target Name="_UnoAdjustResolveReferencedProjectsStaticWebAssetsConfiguration"
			AfterTargets="ResolveReferencedProjectsStaticWebAssetsConfiguration"
			Condition=" $([MSBuild]::VersionGreaterThanOrEquals('$(NETCoreSdkVersion)', '9.0.300')) and '$(UnoDisableGetCurrentProjectBuildStaticWebAssetItems)' != 'true' ">
		<ItemGroup>
			<_UnoStaticWebAssetProjectConfiguration Include="@(StaticWebAssetProjectConfiguration)"  GetBuildAssetsTargets="_UnoAdjustGetCurrentProjectBuildStaticWebAssetItems"/>
			<StaticWebAssetProjectConfiguration Remove="@(StaticWebAssetProjectConfiguration)" />
			<StaticWebAssetProjectConfiguration Include="@(_UnoStaticWebAssetProjectConfiguration)" />
		</ItemGroup>
	</Target>

	<!--
		Update uno-config.js in server publish directory after StaticWebAssets are copied.
		This ensures fingerprints are correct when hosting WASM apps in ASP.NET Core servers.
	-->
	<Target Name="_UnoServerUpdateDotnetJsFingerprintPublish"
			AfterTargets="Publish">

		<Message Importance="low" Text="[Uno.Server] _UnoServerUpdateDotnetJsFingerprintPublish running (PublishDir=$(PublishDir))" />

		<!-- Determine the actual publish directory location -->
		<PropertyGroup>
			<_UnoServerAbsolutePublishDir Condition="'$(PublishDir)' != ''">$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)\$(PublishDir)'))</_UnoServerAbsolutePublishDir>
			<_UnoServerActualPublishDir Condition="'$(_UnoServerAbsolutePublishDir)' != '' AND Exists('$(_UnoServerAbsolutePublishDir)')">$(_UnoServerAbsolutePublishDir)</_UnoServerActualPublishDir>
			<_UnoServerActualPublishDir Condition="'$(_UnoServerActualPublishDir)' == '' AND '$(PublishDir)' != '' AND Exists('$(PublishDir)')">$([System.IO.Path]::GetFullPath('$(PublishDir)'))</_UnoServerActualPublishDir>
		</PropertyGroup>

		<Message Importance="low" Text="[Uno.Server] Checking publish directory: $(_UnoServerActualPublishDir)" />

		<!-- Find the actual dotnet.js file in the publish wwwroot/_framework directory -->
		<ItemGroup>
			<_UnoServerPublishedDotnetJs Include="$(_UnoServerActualPublishDir)wwwroot/_framework/dotnet.*.js"
				Exclude="$(_UnoServerActualPublishDir)wwwroot/_framework/dotnet.native.*.js;$(_UnoServerActualPublishDir)wwwroot/_framework/dotnet.runtime.*.js" />
		</ItemGroup>

		<!-- Extract fingerprint from actual filename -->
		<PropertyGroup>
			<_UnoServerActualDotnetJsFingerprint>$([System.Text.RegularExpressions.Regex]::Match('%(_UnoServerPublishedDotnetJs.Filename)', '^dotnet\.([a-z0-9]+)$').Groups[1].Value)</_UnoServerActualDotnetJsFingerprint>
		</PropertyGroup>

		<!--
			Fallback: when using a custom PublishDir, framework files may be placed directly
			in wwwroot/ root (not wwwroot/_framework/). Compute a hash-based fingerprint.
		-->
		<GetFileHash Files="$(_UnoServerActualPublishDir)wwwroot/dotnet.js"
					 Algorithm="SHA256"
					 HashEncoding="hex"
					 Condition="'$(_UnoServerActualDotnetJsFingerprint)' == '' AND '$(_UnoServerActualPublishDir)' != '' AND Exists('$(_UnoServerActualPublishDir)wwwroot/dotnet.js')">
			<Output TaskParameter="Hash" PropertyName="_UnoServerPublishedDotnetJsHash" />
		</GetFileHash>

		<PropertyGroup Condition="'$(_UnoServerActualDotnetJsFingerprint)' == '' AND '$(_UnoServerPublishedDotnetJsHash)' != ''">
			<_UnoServerActualDotnetJsFingerprint>$(_UnoServerPublishedDotnetJsHash.Substring(0, 10).ToLowerInvariant())</_UnoServerActualDotnetJsFingerprint>
		</PropertyGroup>

		<!-- Find uno-config.js (it could be in a package_* subdirectory) -->
		<ItemGroup Condition="'$(_UnoServerActualDotnetJsFingerprint)' != ''">
			<_UnoServerConfigJs Include="$(_UnoServerActualPublishDir)wwwroot/**/uno-config.js" />
		</ItemGroup>

		<PropertyGroup Condition="'@(_UnoServerConfigJs)' != ''">
			<_UnoServerConfigJsPath>@(_UnoServerConfigJs)</_UnoServerConfigJsPath>
		</PropertyGroup>

		<Message Importance="low"
				 Text="[Uno.Server] Found dotnet.js fingerprint: $(_UnoServerActualDotnetJsFingerprint) at $(_UnoServerActualPublishDir)wwwroot/_framework/"
				 Condition="'$(_UnoServerActualDotnetJsFingerprint)' != ''" />

		<Message Importance="low"
				 Text="[Uno.Server] Updating uno-config.js at: $(_UnoServerConfigJsPath)"
				 Condition="'$(_UnoServerActualDotnetJsFingerprint)' != '' AND '$(_UnoServerConfigJsPath)' != '' AND Exists('$(_UnoServerConfigJsPath)')" />

		<!-- Update uno-config.js in the server publish output with the actual fingerprint -->
		<WriteLinesToFile
			File="$(_UnoServerConfigJsPath)"
			Lines="$([System.Text.RegularExpressions.Regex]::Replace($([System.Text.RegularExpressions.Regex]::Replace($([System.IO.File]::ReadAllText('$(_UnoServerConfigJsPath)')), 'config\.dotnet_js_filename = &quot;dotnet(\.[^&quot;]+)?\.js&quot;', 'config.dotnet_js_filename = &quot;dotnet.$(_UnoServerActualDotnetJsFingerprint).js&quot;')), '_framework/dotnet(\.[^&quot;]+)?\.js', '_framework/dotnet.$(_UnoServerActualDotnetJsFingerprint).js'))"
			Overwrite="true"
			Condition="'$(_UnoServerActualDotnetJsFingerprint)' != '' AND '$(_UnoServerConfigJsPath)' != '' AND Exists('$(_UnoServerConfigJsPath)')" />

		<Message Importance="normal"
				 Text="[Uno.Server] Updated uno-config.js with dotnet.js fingerprint: $(_UnoServerActualDotnetJsFingerprint)"
				 Condition="'$(_UnoServerActualDotnetJsFingerprint)' != '' AND '$(_UnoServerConfigJsPath)' != ''" />
	</Target>

</Project>
